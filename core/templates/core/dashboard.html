<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        h1, h2 { color: #333; }

        /* Controls styling */
        .controls { margin-bottom: 20px; }
        .controls button {
            padding: 10px 15px;
            margin-right: 10px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .controls button.active {
            background-color: #0056b3; /* Highlight active button */
        }

        /* Content display area */
        #dashboard-data {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            min-height: 200px;
            white-space: pre-wrap;
            background-color: #fff;
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Status messages */
        .status {
            font-size: 0.9em;
            color: gray;
            margin-bottom: 10px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }

        /* Forms styling */
        .form-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select { /* Added select to general input styles */
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box; /* Ensures padding and border are included in the width */
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-actions {
            margin-top: 20px;
        }
        .form-actions button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .form-actions button:hover {
            background-color: #218838;
        }
        .form-actions button[type="reset"] {
            background-color: #6c757d;
            margin-left: 10px;
        }
        .form-actions button[type="reset"]:hover {
            background-color: #5a6268;
        }

        /* Password toggle styles (added) */
        .password-group {
            position: relative;
        }
        .password-group input { /* To make space for the icon */
            padding-right: 40px;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 60%; /* Adjust to vertically center with the input, accounting for label */
            transform: translateY(-50%);
            cursor: pointer;
            color: #555;
        }
        .password-toggle:hover {
            color: #333;
        }

        /* Hidden by default */
        #profile-update-section { display: none; }
        #create-service-section { display: none; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>

    <div class="controls">
        <button id="showDashboardDataBtn">Show Dashboard Data</button>
        <button id="showMyRequestsBtn">Show My Service Requests</button>
        <button id="showMyServicesBtn">Show My Created Services</button>
        <button id="showProfileUpdateBtn">Update Profile</button>
        <button id="showCreateServiceBtn">Create New Service</button>
        <button id="logoutBtn">Logout</button>
    </div>

    <div class="status" id="status">Select an option above.</div>

    <div id="dashboard-data">
        <p>Click a button to load data.</p>
    </div>

    <div id="profile-update-section">
        <h2>Update Profile</h2>
        <div id="profile-status" class="status"></div>
        <div class="form-section">
            <h3>Personal Information & Password</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="firstName">First Name:</label>
                    <input type="text" id="firstName" name="first_name">
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name:</label>
                    <input type="text" id="lastName" name="last_name">
                </div>
                <div class="form-group">
                    <label for="bio">Bio:</label>
                    <textarea id="bio" name="bio"></textarea>
                </div>
                <div class="form-group">
                    <label for="location">Location:</label>
                    <input type="text" id="location" name="location">
                </div>
                <div class="form-group">
                    <label for="avatar">Avatar (Base64 or URL):</label>
                    <input type="text" id="avatar" name="avatar" placeholder="Paste Base64 or URL if applicable">
                </div>

                <hr> <h4>Change Password (Optional)</h4>
                <p class="status">Fill these fields ONLY if you want to change your password.</p>
                <div class="form-group password-group">
                    <label for="currentPassword">Current Password:</label>
                    <input type="password" id="currentPassword" name="old_password">
                    <span class="password-toggle" id="toggleCurrentPassword">
                    </span>
                </div>
                <div class="form-group password-group">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" name="new_password1">
                    <span class="password-toggle" id="toggleNewPassword">
                    </span>
                </div>
                <div class="form-group password-group">
                    <label for="confirmNewPassword">Confirm New Password:</label>
                    <input type="password" id="confirmNewPassword" name="new_password2">
                    <span class="password-toggle" id="toggleConfirmNewPassword">
                    </span>
                </div>

                <div class="form-actions">
                    <button type="submit">Update Profile</button>
                    <button type="reset" id="resetProfileForm">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-service-section">
        <h2>Create New Service Offering</h2>
        <div id="create-service-status" class="status"></div>
        <div class="form-section">
            <form id="createServiceForm">
                <div class="form-group">
                    <label for="serviceTitle">Service Title:</label>
                    <input type="text" id="serviceTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="serviceDescription">Description:</label>
                    <textarea id="serviceDescription" name="description" required></textarea>
                </div>

                <div class="form-group">
                    <label for="paymentType">Payment Type:</label>
                    <select id="paymentType" name="payment_type" required>
                        <option value="">-- Select Payment Type --</option>
                        <option value="barter">Barter</option>
                        <option value="token">Tokens (10)</option>
                    </select>
                </div>

                <div id="barterFields" style="display: none;">
                    <div class="form-group">
                        <label for="serviceCategory">Category (Service you are offering):</label>
                        <select id="serviceCategory" name="category"></select>
                    </div>
                    <div class="form-group">
                        <label for="desiredCategory">Desired Category (What you want in return):</label>
                        <select id="desiredCategory" name="desired_category"></select>
                    </div>
                </div>

                <div id="tokenFields" style="display: none;">
                    <div class="form-group">
                        <label for="tokenPrice">Price (Tokens):</label>
                        <input type="text" id="tokenPrice" name="price" value="10" readonly>
                    </div>
                    <div class="form-group">
                        <label for="tokenServiceCategory">Category (Service you are offering):</label>
                        <select id="tokenServiceCategory" name="category"></select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit">Create Service</button>
                    <button type="reset">Clear Form</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Utility Functions ---
    
        // Function to get CSRF token from cookies (essential for Django POST/PATCH requests)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    
        // Removed setupPasswordToggle function as eye icons are no longer needed
    
        function clearAndShowSection(sectionToShow) {
            document.getElementById('dashboard-data').style.display = 'none';
            document.getElementById('profile-update-section').style.display = 'none';
            document.getElementById('create-service-section').style.display = 'none';
    
            sectionToShow.style.display = 'block';
    
            // Reset status messages for all sections
            setStatus(document.getElementById('status'), '', null);
            setStatus(document.getElementById('profile-status'), '', null);
            setStatus(document.getElementById('create-service-status'), '', null);
        }
    
        function setStatus(element, message, type) {
            element.textContent = message;
            element.className = 'status'; // Reset classes
            if (type) {
                element.classList.add(type);
            }
        }
    
        // --- Global Constants ---
        // IMPORTANT: Ensure this URL is correct and accessible from your frontend
        const API_BASE_URL = 'http://localhost:8000/api/';
        const accessToken = localStorage.getItem('access_token');
    
        // Categories (must match backend CATEGORY_CHOICES)
        const CATEGORIES = [
            { value: 'IT_SUPPORT', text: 'IT Support & Troubleshooting' },
            { value: 'GRAPHIC_DESIGN', text: 'Graphic Design & Branding' },
            { value: 'WEB_DEV', text: 'Web Development & Design' },
            { value: 'LANG_TUTOR', text: 'Language Tutoring' },
            { value: 'HOME_REPAIR', text: 'Home Repair & Maintenance' },
            { value: 'CLEANING', text: 'Cleaning Services' },
            { value: 'PET_SITTING', text: 'Pet Sitting & Walking' },
            { value: 'PHOTOGRAPHY', text: 'Photography & Editing' },
            { value: 'CONSULTING', text: 'Business Consulting' },
            { value: 'FITNESS_COACH', text: 'Fitness Coaching' },
            { value: 'EDUCATION', text: 'Education & Tutoring' },
            { value: 'HANDICRAFTS', 'text': 'Handicrafts & Custom Goods' },
        ];
    
    
        // --- Main DOMContentLoaded Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const dashboardDataElement = document.getElementById('dashboard-data');
            const statusElement = document.getElementById('status');
            const profileUpdateSection = document.getElementById('profile-update-section');
            const createServiceSection = document.getElementById('create-service-section');
            const profileForm = document.getElementById('profileForm');
            const createServiceForm = document.getElementById('createServiceForm');
            const profileStatusElement = document.getElementById('profile-status');
            const createServiceStatusElement = document.getElementById('create-service-status');
    
            // Password fields for update profile form
            const currentPasswordField = document.getElementById('currentPassword');
            const newPasswordField = document.getElementById('newPassword');
            const confirmNewPasswordField = document.getElementById('confirmNewPassword');
            const profileFormResetBtn = document.getElementById('resetProfileForm');
    
    
            // Service creation form specific elements
            const paymentTypeSelect = document.getElementById('paymentType');
            const barterFields = document.getElementById('barterFields');
            const tokenFields = document.getElementById('tokenFields');
            const serviceCategorySelect = document.getElementById('serviceCategory');
            const desiredCategorySelect = document.getElementById('desiredCategory');
            const tokenServiceCategorySelect = document.getElementById('tokenServiceCategory');
    
            // Buttons
            const showDashboardDataBtn = document.getElementById('showDashboardDataBtn');
            const showMyRequestsBtn = document.getElementById('showMyRequestsBtn');
            const showMyServicesBtn = document.getElementById('showMyServicesBtn');
            const showProfileUpdateBtn = document.getElementById('showProfileUpdateBtn');
            const showCreateServiceBtn = document.getElementById('showCreateServiceBtn');
            const logoutBtn = document.getElementById('logoutBtn');
    
    
            // --- Removed Initial Setup for Password Toggles ---
    
            // --- Dynamic Password Field Validation ---
            // Function to check if any password field has content
            function arePasswordFieldsTouched() {
                return currentPasswordField.value !== '' ||
                       newPasswordField.value !== '' ||
                       confirmNewPasswordField.value !== '';
            }
    
            // Function to set/remove 'required' attribute
            function updatePasswordRequirements() {
                const touched = arePasswordFieldsTouched();
                currentPasswordField.required = touched;
                newPasswordField.required = touched;
                confirmNewPasswordField.required = touched;
            }
    
            // Add event listeners to password fields to trigger validation
            currentPasswordField.addEventListener('input', updatePasswordRequirements);
            newPasswordField.addEventListener('input', updatePasswordRequirements);
            confirmNewPasswordField.addEventListener('input', updatePasswordRequirements);
    
            // --- Data Fetching and Display (existing functionality) ---
            async function fetchAndDisplayData(endpoint, title) {
                clearAndShowSection(dashboardDataElement);
    
                if (!accessToken) {
                    setStatus(statusElement, 'Error: No access token found. Please log in.', 'error');
                    dashboardDataElement.innerHTML = '';
                    return;
                }
    
                try {
                    setStatus(statusElement, `Fetching ${title.toLowerCase()}... Last updated: ${new Date().toLocaleTimeString()}`);
                    dashboardDataElement.innerHTML = '<p>Loading...</p>';
    
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
    
                    // *** CRITICAL CHANGE FOR THE "Unexpected token '<'" ERROR ***
                    // Always try to read the response as text first, then try to parse as JSON.
                    // This helps in debugging when the server sends HTML instead of JSON.
                    const responseText = await response.text();
    
                    if (!response.ok) {
                        let errorMessage = `HTTP error! Status: ${response.status}`;
                        try {
                            const errorJson = JSON.parse(responseText);
                            errorMessage += ` - ${JSON.stringify(errorJson, null, 2)}`;
                        } catch (e) {
                            errorMessage += ` - Raw Response: ${responseText}`; // Fallback to raw text if not JSON
                        }
                        throw new Error(errorMessage);
                    }
    
                    const data = JSON.parse(responseText); // Now parse it explicitly after checking ok
                    dashboardDataElement.innerHTML = `<h2>${title}</h2><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    setStatus(statusElement, `${title} loaded successfully. Last updated: ${new Date().toLocaleTimeString()}`, 'success');
    
                } catch (error) {
                    console.error(`Error fetching ${title.toLowerCase()} data:`, error);
                    dashboardDataElement.innerHTML = `<p class="error">Failed to load ${title.toLowerCase()}. Error: ${error.message}</p>`;
                    setStatus(statusElement, `Error fetching ${title.toLowerCase()}. Last attempt: ${new Date().toLocaleTimeString()}`, 'error');
                }
            }
    
            // --- Profile Update Functionality (Modified for two API calls) ---
            async function loadUserProfileForEditing() {
                clearAndShowSection(profileUpdateSection);
                
                if (!accessToken) {
                    setStatus(profileStatusElement, 'Error: No access token found. Please log in.', 'error');
                    return;
                }
    
                setStatus(profileStatusElement, 'Loading profile data...', null);
    
                // Reset password fields and their requirements when opening the form
                currentPasswordField.value = '';
                newPasswordField.value = '';
                confirmNewPasswordField.value = '';
                updatePasswordRequirements(); // Ensure fields are not required initially
    
                try {
                    // CORRECTED URL based on your urls.py
                    const response = await fetch(`${API_BASE_URL}me/`, { // Changed from users/me/ to me/
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
    
                    // *** CRITICAL CHANGE FOR THE "Unexpected token '<'" ERROR ***
                    const responseText = await response.text();
    
                    if (!response.ok) {
                        let errorData = {};
                        try {
                            errorData = JSON.parse(responseText);
                        } catch (e) {
                            errorData = { detail: "Server returned non-JSON response.", raw: responseText };
                        }
                        throw new Error(`HTTP error! Status: ${response.status} - ${JSON.stringify(errorData, null, 2)}`);
                    }
    
                    const userData = JSON.parse(responseText); // Now parse it explicitly after checking ok
                    
                    document.getElementById('firstName').value = userData.first_name || '';
                    document.getElementById('lastName').value = userData.last_name || '';
                    document.getElementById('bio').value = userData.bio || '';
                    document.getElementById('location').value = userData.location || '';
                    document.getElementById('avatar').value = userData.avatar || ''; // Assuming avatar is a URL/Base64 string field
    
                    setStatus(profileStatusElement, 'Profile data loaded.', 'success');
    
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    setStatus(profileStatusElement, `Error loading profile: ${error.message}`, 'error');
                }
            }
    
            profileForm.addEventListener('submit', async (event) => {
                event.preventDefault();
    
                setStatus(profileStatusElement, 'Updating profile...', null);
    
                const profilePayload = {
                    first_name: document.getElementById("firstName").value,
                    last_name: document.getElementById("lastName").value,
                    bio: document.getElementById("bio").value,
                    location: document.getElementById("location").value,
                    avatar: document.getElementById("avatar").value
                };
    
                const updatePassword = arePasswordFieldsTouched();
                let passwordChangeAttempted = false; // Flag to know if password change was part of this submission
                let passwordChangeSuccessful = true; // Assume success for password part unless it fails
    
                try {
                    // --- 1. Update Profile Information (PATCH /me/) ---
                    // CORRECTED URL based on your urls.py
                    const profileResponse = await fetch(`${API_BASE_URL}me/`, {
                        method: 'PATCH', // Use PATCH for partial updates
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            "X-CSRFToken": csrftoken // Include CSRF token
                        },
                        body: JSON.stringify(profilePayload)
                    });
    
                    const profileResponseText = await profileResponse.text(); // Read as text
    
                    if (!profileResponse.ok) {
                        let errorData = {};
                        try {
                            errorData = JSON.parse(profileResponseText);
                        } catch (e) {
                            errorData = { detail: "Server returned non-JSON response for profile update.", raw: profileResponseText };
                        }
                        let errorMessage = `Error updating profile: HTTP status ${profileResponse.status}`;
                        if (errorData) {
                            for (const key in errorData) {
                                errorMessage += `\n${key}: ${Array.isArray(errorData[key]) ? errorData[key].join(', ') : errorData[key]}`;
                            }
                        }
                        throw new Error(errorMessage); // This will be caught by the outer catch
                    }
    
                    // --- 2. Conditionally Change Password (POST /password/change/) ---
                    if (updatePassword) {
                        passwordChangeAttempted = true;
                        const currentPassword = currentPasswordField.value;
                        const newPassword = newPasswordField.value;
                        const confirmNewPassword = confirmNewPasswordField.value;
    
                        // Client-side validation for password fields
                        if (!currentPassword || !newPassword || !confirmNewPassword) {
                            setStatus(profileStatusElement, 'Please fill all password fields or clear them to update only profile info.', 'error');
                            passwordChangeSuccessful = false;
                        } else if (newPassword !== confirmNewPassword) {
                            setStatus(profileStatusElement, 'New passwords do not match!', 'error');
                            passwordChangeSuccessful = false;
                        } else if (newPassword.length < 8) { // Basic password length validation
                            setStatus(profileStatusElement, 'New password must be at least 8 characters long.', 'error');
                            passwordChangeSuccessful = false;
                        }
                        
                        if (passwordChangeSuccessful) { // Only proceed to API call if client-side validation passed
                            const passwordPayload = {
                                old_password: currentPassword,
                                new_password1: newPassword,
                                new_password2: confirmNewPassword
                            };
    
                            // CORRECTED URL based on your urls.py
                            const passwordResponse = await fetch(`${API_BASE_URL}password/change/`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`,
                                    'Content-Type': 'application/json',
                                    "X-CSRFToken": csrftoken
                                },
                                body: JSON.stringify(passwordPayload)
                            });
    
                            const passwordResponseText = await passwordResponse.text(); // Read as text
    
                            if (!passwordResponse.ok) {
                                let errorData = {};
                                try {
                                    errorData = JSON.parse(passwordResponseText);
                                } catch (e) {
                                    errorData = { detail: "Server returned non-JSON response for password change.", raw: passwordResponseText };
                                }
                                let errorMessage = `Error changing password: HTTP status ${passwordResponse.status}`;
                                if (errorData) {
                                    for (const key in errorData) {
                                        errorMessage += `\n${key}: ${Array.isArray(errorData[key]) ? errorData[key].join(', ') : errorData[key]}`;
                                    }
                                }
                                throw new Error(errorMessage); // This will be caught by the outer catch
                            }
                        }
                    }
    
                    // --- Final Status Message ---
                    if (passwordChangeAttempted && !passwordChangeSuccessful) {
                        // Error message already set by the failed password validation
                    } else if (passwordChangeAttempted && passwordChangeSuccessful) {
                        setStatus(profileStatusElement, 'Profile updated and password changed successfully!', 'success');
                    } else { // Profile updated, no password change attempted
                        setStatus(profileStatusElement, 'Profile updated successfully!', 'success');
                    }
    
                    // Always clear password fields and reset requirements after submission attempt
                    currentPasswordField.value = '';
                    newPasswordField.value = '';
                    confirmNewPasswordField.value = '';
                    updatePasswordRequirements();
    
                } catch (error) {
                    console.error('Error during profile update or password change:', error);
                    setStatus(profileStatusElement, `Error: ${error.message}`, 'error');
                    // Ensure password fields are cleared even on error if they were part of the submission
                    currentPasswordField.value = '';
                    newPasswordField.value = '';
                    confirmNewPasswordField.value = '';
                    updatePasswordRequirements();
                }
            });
    
            // Handle the custom reset button to also clear password requirements
            profileFormResetBtn.addEventListener('click', () => {
                // Form's default reset will clear values, then manually reset requirements
                setTimeout(() => { // Small delay to let browser's reset complete
                    updatePasswordRequirements();
                }, 0);
            });
    
            // --- Logout Functionality ---
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                alert('You have been logged out.');
                window.location.href = '/'; // Redirect to home or login page
            });
    
    
            // --- NEW: Create Service Functionality ---
    
            // Function to populate category dropdowns
            function populateCategoryDropdowns() {
                serviceCategorySelect.innerHTML = '<option value="">-- Select Category --</option>';
                desiredCategorySelect.innerHTML = '<option value="">-- Select Desired Category --</option>';
                tokenServiceCategorySelect.innerHTML = '<option value="">-- Select Category --</option>';
    
                CATEGORIES.forEach(category => {
                    const option1 = document.createElement('option');
                    option1.value = category.value;
                    option1.textContent = category.text;
                    serviceCategorySelect.appendChild(option1);
    
                    const option2 = document.createElement('option');
                    option2.value = category.value;
                    option2.textContent = category.text;
                    desiredCategorySelect.appendChild(option2);
    
                    const option3 = document.createElement('option');
                    option3.value = category.value;
                    option3.textContent = category.text;
                    tokenServiceCategorySelect.appendChild(option3);
                });
            }
    
            // Logic to show/hide fields based on payment type selection
            paymentTypeSelect.addEventListener('change', () => {
                const selectedType = paymentTypeSelect.value;
                if (selectedType === 'barter') {
                    barterFields.style.display = 'block';
                    tokenFields.style.display = 'none';
                    serviceCategorySelect.setAttribute('required', 'required');
                    desiredCategorySelect.setAttribute('required', 'required');
                    tokenServiceCategorySelect.removeAttribute('required');
                } else if (selectedType === 'token') {
                    barterFields.style.display = 'none';
                    tokenFields.style.display = 'block';
                    tokenServiceCategorySelect.setAttribute('required', 'required');
                    serviceCategorySelect.removeAttribute('required');
                    desiredCategorySelect.removeAttribute('required');
                } else {
                    barterFields.style.display = 'none';
                    tokenFields.style.display = 'none';
                    serviceCategorySelect.removeAttribute('required');
                    desiredCategorySelect.removeAttribute('required');
                    tokenServiceCategorySelect.removeAttribute('required');
                }
            });
    
            // Handle Create Service Form Submission
            createServiceForm.addEventListener('submit', async (event) => {
                event.preventDefault();
    
                setStatus(createServiceStatusElement, 'Creating service...', null);
    
                const title = document.getElementById('serviceTitle').value;
                const description = document.getElementById('serviceDescription').value;
                const paymentType = document.getElementById('paymentType').value;
                let category = '';
                let desired_category = null;
                let price = 0;
    
                if (paymentType === 'barter') {
                    category = document.getElementById('serviceCategory').value;
                    desired_category = document.getElementById('desiredCategory').value;
                    price = 0;
                } else if (paymentType === 'token') {
                    category = document.getElementById('tokenServiceCategory').value;
                    price = 10;
                } else {
                    setStatus(createServiceStatusElement, 'Please select a payment type.', 'error');
                    return;
                }
    
                const payload = {
                    title: title,
                    description: description,
                    payment_type: paymentType,
                    category: category,
                    desired_category: desired_category,
                    price: price
                };
    
                if (!title || !description || !paymentType || !category || (paymentType === 'barter' && !desired_category)) {
                    setStatus(createServiceStatusElement, 'Please fill in all required fields.', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}services/`, { // Assuming /api/services/
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            "X-CSRFToken": csrftoken // Include CSRF token
                        },
                        body: JSON.stringify(payload)
                    });
    
                    const responseText = await response.text(); // Read as text
    
                    if (!response.ok) {
                        let errorData = {};
                        try {
                            errorData = JSON.parse(responseText);
                        } catch (e) {
                            errorData = { detail: "Server returned non-JSON response for service creation.", raw: responseText };
                        }
                        let errorMessage = `HTTP error! Status: ${response.status} - ${JSON.stringify(errorData, null, 2)}`;
                        throw new Error(errorMessage);
                    }
    
                    const newService = JSON.parse(responseText); // Now parse it explicitly
                    console.log('Service created successfully:', newService);
                    setStatus(createServiceStatusElement, 'Service created successfully!', 'success');
                    createServiceForm.reset();
                    paymentTypeSelect.dispatchEvent(new Event('change'));
    
                    fetchAndDisplayData('my-services/', 'My Created Services');
    
                } catch (error) {
                    console.error('Error creating service:', error);
                    setStatus(createServiceStatusElement, `Error creating service: ${error.message}`, 'error');
                }
            });
    
            // --- Button Event Listeners ---
            showDashboardDataBtn.addEventListener('click', () => {
                fetchAndDisplayData('dashboard/', 'General Dashboard Data');
            });
    
            showMyServicesBtn.addEventListener('click', () => {
                fetchAndDisplayData('my-services/', 'My Created Services');
            });
    
            showMyRequestsBtn.addEventListener('click', () => {
                fetchAndDisplayData('requests/', 'My Service Requests');
            });
    
            showProfileUpdateBtn.addEventListener('click', loadUserProfileForEditing);
    
            showCreateServiceBtn.addEventListener('click', () => {
                clearAndShowSection(createServiceSection);
                populateCategoryDropdowns();
                paymentTypeSelect.value = "";
                paymentTypeSelect.dispatchEvent(new Event('change'));
                createServiceForm.reset();
                setStatus(createServiceStatusElement, '', null);
            });
    
            // Initial load
            fetchAndDisplayData('dashboard/', 'General Dashboard Data');
        });
    </script>
</body>
</html>