{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  <h1>Your Conversations</h1>
  <ul id="roomList" class="list-group">
    {% for room in chat_rooms %}
      <li id="room-{{ room.id }}" class="list-group-item d-flex justify-content-between align-items-center {% if room.unread_count %}fw-bold{% endif %}">
        Chat with {{ room.other_user.username }}
        {% if room.unread_count %}
          <span class="badge bg-danger unread-badge">{{ room.unread_count }}</span>
        {% endif %}
        <a href="{% url 'chat_room' room.id %}" class="btn btn-sm btn-outline-secondary">Open</a>
      </li>
    {% empty %}
      <li id="no-conversations" class="list-group-item">No conversations yet.</li>
    {% endfor %}
  </ul>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const roomList = document.getElementById('roomList');
  const roomSocket = new WebSocket(`ws://${window.location.host}/ws/rooms/`);

  roomSocket.onopen = () => {
    console.log("ðŸ“¡ Room notification socket connected.");
  };

  roomSocket.onmessage = e => {
    const data = JSON.parse(e.data);
    const roomId = data.room_id;
    let roomElement = document.getElementById(`room-${roomId}`);
    let unreadBadge;

    if (data.type === 'new_room') {
      if (!roomElement) {
        const li = document.createElement('li');
        li.id = `room-${roomId}`;
        li.className = 'list-group-item fw-bold d-flex justify-content-between align-items-center';
        li.innerHTML = `
          Chat with ${data.other_user_username}
          <span class="badge bg-danger unread-badge">${data.unread_count || 1}</span>
          <a href="/chat/room/${roomId}/" class="btn btn-sm btn-outline-secondary">Open</a>
        `;

        const noConversationsElement = document.getElementById('no-conversations');
        if (noConversationsElement) {
          noConversationsElement.remove();
        }
        roomList.prepend(li);
        roomElement = li;
      } else {
        roomElement.classList.add('fw-bold');
        unreadBadge = roomElement.querySelector('.unread-badge');
        if (unreadBadge) {
            unreadBadge.textContent = data.unread_count;
        } else {
            const newBadge = document.createElement('span');
            newBadge.className = 'badge bg-danger unread-badge';
            newBadge.textContent = data.unread_count;
            roomElement.insertBefore(newBadge, roomElement.querySelector('a'));
        }
      }

      if (roomElement) {
          roomElement.classList.add('blink');
          setTimeout(() => roomElement.classList.remove('blink'), 1500);
      }

    } else if (data.type === 'unread_count_update') {
        if (roomElement) {
            unreadBadge = roomElement.querySelector('.unread-badge');
            if (data.unread_count > 0) {
                if (unreadBadge) {
                    unreadBadge.textContent = data.unread_count;
                } else {
                    const newBadge = document.createElement('span');
                    newBadge.className = 'badge bg-danger unread-badge';
                    newBadge.textContent = data.unread_count;

                    const openButton = roomElement.querySelector('a.btn');
                    if (openButton) {
                        roomElement.insertBefore(newBadge, openButton);
                    } else {

                        roomElement.appendChild(newBadge);
                    }
                }
                roomElement.classList.add('fw-bold');
                roomElement.classList.add('blink');
                setTimeout(() => roomElement.classList.remove('blink'), 1500);
            } else {
                if (unreadBadge) {
                    unreadBadge.remove();
                }
                roomElement.classList.remove('fw-bold');
            }
        }
    }
  };

  roomSocket.onerror = e => console.error("WebSocket error:", e);
  roomSocket.onclose = () => console.warn("Room notification WebSocket closed.");
});
</script>

<style>

@keyframes blink-animation {
  0%, 100% { background-color: transparent; }
  50% { background-color: #f8d7da; /* Light red/pink for highlighting */ }
}

.blink {
  animation: blink-animation 1.5s ease-in-out;
}
</style>
{% endblock %}

