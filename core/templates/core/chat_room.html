{% extends 'base.html' %}
{% block title %}Chat: {{ other_user.username }}{% endblock %}

{% block content %}
  <h1>{{ other_user.username }}</h1>
  <div id="chatBox" class="chat-container border p-3 mb-3">
    {% for msg in messages %}
      <div class="message {% if msg.sender == request.user %}me{% else %}them{% endif %}">
        <div class="bubble">
          <small class="sender">{{ msg.sender.username }}</small><br>
          {{ msg.text }}<br>
          <small class="timestamp">{{ msg.timestamp|date:"H:i" }}</small>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="input-group">
    <input id="messageInput" type="text" class="form-control" placeholder="Type a messageâ€¦">
    <button id="sendBtn" class="btn btn-primary">Send</button>
  </div>  
{% endblock %}

{% block extra_js %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const roomId = "{{ active_room.id }}";
    const userName = "{{ request.user.username }}";
    const chatBox = document.getElementById('chatBox');
    const socket = new WebSocket(`ws://${window.location.host}/ws/chat/${roomId}/`);

    socket.onmessage = e => {
      const data = JSON.parse(e.data);
      const div = document.createElement('div');
      div.className = 'message ' + (data.sender_username === userName ? 'me' : 'them');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = `
        <small class="sender">${data.sender_username}</small><br>
        ${data.message}<br>
        <small class="timestamp">${data.timestamp}</small>
      `;
      if (data.sender_username !== userName) {
        bubble.classList.add('blink');
        setTimeout(() => bubble.classList.remove('blink'), 1000);
      }
      div.appendChild(bubble);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    document.getElementById('sendBtn').onclick = () => {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (!msg) return;
      socket.send(JSON.stringify({ message: msg }));
      input.value = '';
    };
  });
</script>
<style>
    .timestamp {
    font-size: 0.7rem;
    color: #aaa;
    float: right;
    margin-top: 4px;
  }
  .chat-container {
    height: 400px;
    overflow-y: auto;
    background: #121212;
    border-radius: 8px;
    padding: 10px;
  }

  .message {
    display: flex;
    margin-bottom: 10px;
  }

  .message.them {
    justify-content: flex-start;
  }

  .message.me {
    justify-content: flex-end;
  }

  .bubble {
    max-width: 70%;
    padding: 10px;
    border-radius: 12px;
    position: relative;
    font-size: 14px;
  }

  .message.them .bubble {
    background-color: #f1f0f0;
    color: #000;
  }

  .message.me .bubble {
    background-color: #b2f2bb;
    color: #000;
    text-align: right;
  }

  .sender {
    font-size: 0.75rem;
    font-weight: bold;
    color: #666;
  }

  .blink { animation: blink 1s linear; }
  @keyframes blink { 50% { opacity: 0; } }
</style>
{% endblock %}
